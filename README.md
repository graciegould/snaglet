# Vite (React) + Express + Firebase (Hybrid Auth Model)

This project is a boilerplate for a full-stack application using a robust hybrid authentication and data access model.

-   **Frontend**: React with TypeScript, managed and built by Vite.
-   **Backend**: An Express.js server written in JavaScript.
-   **Database/Auth**: Firebase (Firestore, Authentication, Storage).

## Core Architecture: Hybrid Model

This application uses a hybrid model that combines the best of client-side and server-side interactions with Firebase.

1.  **Client-Side SDK**: The React app uses the Firebase Client SDK to handle user authentication (sign-in/out) and to perform simple, safe database operations directly (e.g., reading public data, writing to a user's own document). This enables real-time listeners and low-latency UI updates.

2.  **Server-Side Admin SDK**: The Express server uses the Firebase Admin SDK, initialized with a secret service account key. This gives the server privileged access to the database, which it uses for two purposes:
    -   To perform sensitive operations that a client can never be trusted with.
    -   To act on behalf of an authenticated user after verifying their ID token.

3.  **Firebase Security Rules (The Bridge)**: The Firestore Security Rules are configured to deny most client-side access by default, but open up specific, safe pathways. For example, allowing an authenticated user to modify only their own data.

4.  **Authenticated API**: The Express server exposes secure API endpoints. The client sends the logged-in user's Firebase ID Token in the `Authorization` header. The server has middleware to verify this token, ensuring that the endpoint can only be accessed by a valid, authenticated user.

## Project Structure

-   `/public`: Static assets for the Vite frontend.
-   `/src`: React application source code (components, assets, etc. - `.tsx`, `.ts` files).
    -   `/src/scss`: Contains global SCSS files (e.g., `main.scss`).
    -   `/src/components`: Example directory for React components. Component-specific styles can be SCSS modules (e.g., `MyComponent.module.scss`).
-   `/server`: Contains the Express.js backend server source code (`server.js` and API routes like `server/api/api.js`).
-   `vite.config.ts`: Vite configuration file (TypeScript).
-   `tsconfig.json`: TypeScript configuration, primarily for the client-side (`/src`) type checking.
-   `package.json`: Project dependencies and scripts.
-   `dist/`: Output directory for the production build of the React frontend (generated by `npm run build`).
-   `/src/lib/firebase.ts`: Initializes the **client-side** Firebase SDK.
-   `/server/server.js`: Initializes the **server-side** Firebase Admin SDK and defines API endpoints.
-   `/server/firebase-service-account-key.json`: **(Local Only, Not in Git)** Your secret key for the Admin SDK.
-   `.env`: **(Local Only, Not in Git)** Your client-side Firebase configuration.

## Getting Started

### 1. Prerequisites

-   Node.js (v18 or later recommended)
-   npm (comes with Node.js)
-   A Firebase Project with Firestore and Authentication enabled.

### 2. Setup

1.  **Install dependencies**: `npm install`
2.  **Server Credentials**:
    -   Go to your Firebase project settings -> "Service accounts".
    -   Click "Generate new private key" and download the JSON file.
    -   Rename the file to `firebase-service-account-key.json` and place it inside the `/server` directory.
3.  **Client Credentials**:
    -   Go to your Firebase project settings -> "General" -> "Your apps".
    -   Find your web app's configuration object.
    -   Create a file named `.env` in the project root.
    -   Copy your client-side config into `.env`, prefixing each key with `VITE_` (e.g., `VITE_FIREBASE_API_KEY="your-key"`).
4.  **Security Rules**:
    -   Go to your Firestore Database -> "Rules" tab.
    -   Update your rules to allow specific client-side access (see example in the "Firebase Security Rules" section below).

### 3. Running the App

Run `npm run dev`. This single command starts your Express server, which uses Vite as middleware to serve the React frontend. Your app will be available at `http://localhost:3001`.

## Firebase Security Rules Example

The security of this hybrid model depends on your rules. The default should be to deny all access, and then open up specific paths for specific conditions.

```json
// Example rules to put in your Firestore console
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // A user can read/write/update their own document in the 'users' collection
    match /users/{userId} {
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
    }
    // Anyone can read from a 'public_content' collection
    match /public_content/{docId} {
        allow read: if true;
        allow write: if false; // Only server can write
    }
  }
}
```

This setup ensures that even if someone has your client-side config, they can only perform the actions explicitly allowed by your rules. All other sensitive actions must go through your secure server API.

## Styling with SCSS

This project is configured to use SCSS for styling:

-   **Global Styles**: The file `src/scss/main.scss` is imported into `src/main.tsx` and provides global styles for the application. You can define global variables, mixins, and base styles here.
-   **SCSS Modules**: For component-specific styles, you can use SCSS Modules. Create a file named `YourComponent.module.scss` alongside your component (e.g., in `src/components/YourComponent/`). Import these styles into your component like so:
    ```typescript
    import styles from './YourComponent.module.scss';

    const YourComponent = () => (
      <div className={styles.yourClass}>Styled Content</div>
    );
    ```
    Vite handles the processing of these module files, ensuring class names are unique to the component.
-   **Type Safety**: The `src/vite-env.d.ts` file includes a declaration for `*.module.scss` files, providing TypeScript support for SCSS modules.

## Server Details (`server/server.js`)

The `server/server.js` file sets up the Express server:
-   It's written in JavaScript (ES Modules).
-   Uses `dotenv` to load environment variables from a `.env` file (create one if you need it).
-   Mounts an API router (example in `server/api/api.js`) at the `/api` path.
-   **In Development Mode** (`process.env.NODE_ENV !== 'production'`):
    -   It dynamically imports and uses Vite as middleware to serve the React frontend from `/src`.
-   **In Production Mode** (`process.env.NODE_ENV === 'production'`):
    -   It serves static files from the `../dist` directory (relative to `server/server.js`, pointing to the frontend build output).
-   Includes a catch-all route (`app.get('*', ...)` when serving static files in production, ensuring that direct navigation to frontend routes serves `index.html`, allowing React Router (if used) to handle routing on the client side.
-   Is configured to listen on a port (defaulting to 3001, configurable via `process.env.PORT`).
